<!-- DOCTYPE HTML -->
<html>
    <head>
        <title>Star Wars API Search</title>
    </head>
    
    <body>
        <div id="content">
            <!-- Placeholder -->
        </div>
    
        <!-- Scripts -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>   
        <script src="https://fb.me/react-0.14.6.js"></script>
        <script src="https://fb.me/react-dom-0.14.6.js"></script>
        <script src="http://fb.me/JSXTransformer-0.12.1.js"></script>
        <script type="text/jsx">
            let App,
                SearchField,
                ResultsListing,
                ResultsItem;
            App = React.createClass({
                render: function() {
                    return (
                        <div className="app-wrapper">
                            <HeroWrapper />
                            <SearchComponent />
                        </div>
                    )
                }
            });
            
            function HeroWrapper() {
                return (
                    <div className="hero-wrapper">
                        <img src='https://static-mh.content.disney.io/starwars/assets/navigation/sw_logo_stacked-336c62367939.png'/>
                        <div>Archives from a long time ago, in a galaxy far, far away...</div>
                    </div>
                );
            }

            SearchComponent = React.createClass({
                getInitialState: function() {
                    return {
                        searchResults: [],
                        loading: false,
                        searchValue: '',
                        updateSearchValue: this.updateSearchValue,
                        category: this.updateCategory,
                        selectedCategory: 'planets'
                    }
                },

                updateSearchValue: function(e) {
                    this.setState({
                        searchValue: e.currentTarget.value
                    });
                },

                updateCategory: function(e) {
                    this.setState({
                        selectedCategory: e.currentTarget.value
                    });
                },

                search: function(URL) {
                    this.setState({
                        loading: true
                    });

                    $.ajax({
                        type: "GET",
                        dataType: 'json',
                        url: URL,
                        success: function(response) {
                            this.showResults(response);
                        }.bind(this)

                    });
                },

                showResults: function(response) {
                    this.setState({
                        loading: false,
                        searchResults: response.results
                    });
                },

                render: function() {
                    const { loading } = this.state;
                    return (
                        <div className="search-component-wrapper">
                            <SearchField 
                                searchValue={this.state.searchValue}
                                updateSearchValue={this.state.updateSearchValue}
                                category={this.state.category} 
                                selectedCategory={this.state.selectedCategory}
                                search={this.search}
                            />
                            {this.buildStateMarkup()}
                        </div>
                    )
                },
                
                buildStateMarkup: function() {
                    return this.state.loading ? this.buildLoadingStateMarkup() : this.buildPopulatedMarkup();
                },
                
                buildLoadingStateMarkup: function() {
                    return <div>Loading Results...</div>;
                },
                
                buildPopulatedMarkup: function() {
                    return <ResultsListing searchResults={this.state.searchResults}/>

                }
            });
            
            SearchField = React.createClass({
                render: function() {
                    return (
                        <div className="search-field-wrapper">
                            <form onKeyUp={this.createAjax}>
                                <input 
                                    type="text" 
                                    ref="query" 
                                    value={this.props.searchValue}
                                    onChange={this.props.updateSearchValue}
                                />
                                
                                <CategorySelector 
                                    category={this.props.category}
                                />
                                
                                <button type="submit">
                                    Search
                                </button>
                            </form>
                        </div>
                    )
                },
                createAjax: function(e) {
                    let url = 'https://swapi.co/api/' + this.props.selectedCategory + '?format=json&search=' + this.props.searchValue;
                    
                    // Prevent page refresh
                    e.preventDefault();
                    
                    this.props.search(url);
                }
            });

            CategorySelector = React.createClass({
                render: function() {
                    return(
                        <select ref="category" 
                            onChange={this.props.category}>
                            <option value="planets">Planets</option>
                            <option value="starships">Spaceships</option>
                            <option value="vehicles">Vehicles</option>
                            <option value="people">People</option>
                            <option value="films">Films</option>
                            <option value="species">Species</option>
                        </select>
                    )
                }
            });

            ResultsListing = React.createClass({
                render: function(){
                    let resultItems = this.props.searchResults.map(function(result) {
                        return <ResultItem key={result.url} name={result.name} />
                    });

                    if (resultItems.length) {
                        return(
                            <ul>
                               {resultItems}
                            </ul>           
                        );
                    } else {
                        return(
                            <div>
                                These are not the results you're looking for... move along.
                            </div>
                        );
                    }

                }
            });

            ResultItem = React.createClass({
                render: function(){
                    return <li>{this.props.name}</li>;
                }
            });

            ReactDOM.render(<App />,  document.getElementById("content"));

        </script>

        <style>
            .hero-wrapper {
                background: black;
                color: white;
                text-align: center;
            }
        </style>
</html>